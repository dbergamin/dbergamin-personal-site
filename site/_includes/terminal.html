<div id="terminal-container">
  <div id="terminal-header">
     <span id="terminal-title">dansh - guest@danielbergamin.net</span>
  </div>
  <div id="terminal-body" class="background-nodes">
    <div id="terminal-command-template" style="display: none">
      <span class="terminal-prompt"></span>
      <span class="terminal-command"></span>
    </div>
    <div id="terminal-output-template" style="display: none">
      <span class="terminal-output"></span>
    </div>
    <div class="terminal-line">
      <span class="terminal-prompt">guest@danielbergamin.net:~ $ </span>
      <span class="terminal-command">cd public/</span>
    </div>
    <div class="terminal-line">
      <span class="terminal-prompt">guest@danielbergamin.net:~/public $ </span>
      <span class="terminal-command">ls</span>
    </div>
    <div class="terminal-line">
      <span class="terminal-output">
        <span><a href="{% link blog.markdown %}">[ blog/ ]</a></span>
        <span><a href="{% link about.markdown %}">[ about.html ]</a></span>
        <span><a href="{% link cv.markdown %}">[ cv.html ]</a></span>
      </span>
    </div>
    <div class="terminal-line">
      <span class="terminal-prompt">guest@danielbergamin.net:~/public $ </span>
      <input id="active-terminal-command" class="terminal-command" autofocus/><span id="terminal-cursor">â–ˆ</span>
    </div>
  </div>
</div>

<!-- Make our vanity shell interface tick -->
<script type="text/javascript">
  // Make the input resize dynamically so the fake blinking caret can stick at the end
  var TERMINAL_BODY = document.querySelector('#terminal-body');
  var TERMINAL_INPUT = document.querySelector('#active-terminal-command');
  TERMINAL_INPUT.addEventListener('input', resizeInput);
  resizeInput.call(TERMINAL_INPUT);

  function resizeInput() {
    // Throw an error if too much text gets dumped in
    if (this.getBoundingClientRect().width >= this.parentElement.getBoundingClientRect().width) {
      leaveMeAlone();
      this.value = "";
    }
    this.style.width = this.value.length + "ch";
  }

  // Make the entire line focus the input as it will start at zero length
  document.querySelector('#terminal-body').addEventListener("click",function() {
    document.querySelector('#active-terminal-command').focus();
  });

  /* Logic to handle basic commands */
  // Constants
  const NO_ARGS = "";
  const RETURN = 13;
  const FILE = "_file_object";
  
  // Globals holding the 'terminal' state
  // It would be great if JS supported more appropriate data types, but I'd rather slog through
  // with objects and arrays than add a dependency for a very limited problem.
  var TERMINAL_ACTIVE_DIR = ["~","public"];
  var TERMINAL_FILESYSTEM = {
    "~": {
      'public': {
        "blog": {
          "TODO :)": FILE
        },
        "about.html": FILE,
        "cv.html": FILE
      }
    }
  };

  // List of commands
  supportedCommands = {
    'cd(.*)?': commandChangeDir,
    'ls(.*)?': commandListDir,
    'print(.*)?': commandPrint
  };

  // REPL 'logic'
  TERMINAL_INPUT.addEventListener('keyup', evaluate);
  
  function evaluate(event) {
    matchedCommand = false;

    if (event.keyCode === RETURN) {
      input = this.value.toLowerCase();
      Object.keys(supportedCommands).forEach(function(command) {
        if (input.match(command)) {
          // Record the user input
          recordCommandInTerminal();

          // If input matches a command definition, invoke the command with the raw input string
          spacePosition = input.indexOf(" ");
          var userCommandArgs;
          if (spacePosition >= 0) {
            userCommandArgs = input.substring(spacePosition + 1);
          } else {
            userCommandArgs = NO_ARGS;
          }
          supportedCommands[command](userCommandArgs);
          matchedCommand = true;
        }
      });

      if (!matchedCommand) {
        commandNotFound(input);
      }
      
      // Reset the active command prompt
      TERMINAL_BODY.lastElementChild.getElementsByClassName('terminal-command')[0].value = '';
      resizeInput.call(TERMINAL_INPUT);
      TERMINAL_BODY.scrollTop = TERMINAL_BODY.scrollHeight;
    }
  }

  /*
   * Records the current command and prepare the terminal for the next command
   * 1. Create a new terminal line object with values based on the command entered
   * 2. Drop it into place in the 'shell' on the penultimate line
   * 3. Clean up the active command line so the user can type a new command
   */
  function recordCommandInTerminal() {
    // Grab the final line of the terminal; containing the active command and store the command text
    var commandLine = TERMINAL_BODY.lastElementChild;
    var commandText = commandLine.getElementsByClassName('terminal-command')[0].value;

    // Create the line to be returned with appropriate values
    var newLine = document.querySelector('#terminal-command-template').cloneNode(true);
    with (newLine) {
      getElementsByClassName('terminal-command')[0].innerText = commandText;
      getElementsByClassName('terminal-prompt')[0].innerText = getTerminalPath();
      id = '';
      className = 'terminal-line';
      removeAttribute('style');
    }

    // Insert it
    TERMINAL_BODY.insertBefore(newLine,commandLine);
  }

  function printFiles(files) {

  }

  function printText(text) {
    var commandLine = TERMINAL_BODY.lastElementChild;

    // Create the line to be returned from the template
    var newLine = document.querySelector('#terminal-output-template').cloneNode(true);

    with (newLine) {
      getElementsByClassName('terminal-output')[0].innerText = text;
      id = '';
      className = 'terminal-line';
      removeAttribute('style');
    }

    // Insert it
    TERMINAL_BODY.insertBefore(newLine,commandLine);
  }

  function getTerminalPath() {
    return `guest@danielbergamin.net:${TERMINAL_ACTIVE_DIR.join('/')} $`;
  }

  /*
   * Command implementations
   * Parameters:
   *   args: The raw string that follows the space after the command invocation
   *         e.g. the command "print hello 123" would pass "hello 123" in as args.
   */

  // Prints a new line onto the terminal
  function commandPrint(args) {
    printText(args);
  }

  // List contents of directory
  function commandListDir() {
    var i = 0;
    var seekDir = TERMINAL_FILESYSTEM;
    while (i < TERMINAL_ACTIVE_DIR.length) {
      seekDir = seekDir[TERMINAL_ACTIVE_DIR[i]];
      i = i + 1;
    }

    // seekDir will now hold the contents of the active directory, which we want to list
    printFiles(seekDir);
  }

  // Move the directory
  function commandChangeDir() {
    //TODO
  }

  function commandNotFound(args) {
    alert("command " + args + " not found");
  }

  // Generic error behaviour
  function leaveMeAlone() {
    alert("Please don't try to break my fragile imitation of a shell, no bug bounties to be found here.");
  }

</script>